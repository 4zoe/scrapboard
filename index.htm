<!doctype html>
<html lang="en">
<head>
<meta charset="utf-8"/>
<meta name="viewport" content="width=device-width,initial-scale=1"/>
<title>SCRAPBOARD</title>
<link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;600;700&display=swap" rel="stylesheet">
<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
<style>
/* Theme Definitions */
:root {
 --bg: #020a0f; --card: #07101a; --text: #e6f7ff; --muted: #9fb3c8;
 --accent: #ffd166; --accent2: #7ee7c7; --glass: rgba(255,255,255,0.06);
 --success: #2ecc71; --danger: #ff6b6b; --nav: #0b1a27; --border: rgba(255,255,255,0.1);
}

[data-theme="light"] {
 --bg: #f1f5f9; --card: #ffffff; --text: #0f172a; --muted: #64748b;
 --accent: #d97706; --accent2: #059669; --glass: rgba(0,0,0,0.04);
 --success: #16a34a; --danger: #dc2626; --nav: #ffffff; --border: rgba(0,0,0,0.1);
}

* { box-sizing: border-box; transition: background 0.2s, border 0.2s; }
body { margin: 0; font-family: 'Inter', sans-serif; background: var(--bg); color: var(--text); line-height: 1.5; }

/* Navigation */
nav { 
 background: var(--nav); padding: 0 20px; display: flex; align-items: center; 
 height: 70px; border-bottom: 1px solid var(--border); position: sticky; top: 0; z-index: 1000;
}
.nav-brand { font-weight: 700; font-size: 1.4em; display: flex; align-items: center; gap: 10px; margin-right: 40px; }
.nav-brand i { color: var(--accent); }
.nav-tabs { display: flex; gap: 8px; align-items: center; }
.tab-btn { 
 background: none; border: none; color: var(--muted); padding: 8px 16px; cursor: pointer; 
 font-weight: 600; border-radius: 8px; display: flex; align-items: center; gap: 8px;
}
.tab-btn:hover { background: var(--glass); }
.tab-btn.active { color: var(--accent); background: var(--glass); }
.nav-right { margin-left: auto; display: flex; align-items: center; gap: 15px; }

/* Theme Toggle Button */
.theme-btn { 
 cursor: pointer; background: var(--glass); border: 1px solid var(--border); 
 color: var(--text); padding: 10px; border-radius: 12px; width: 44px; text-align: center;
}

/* Layout */
.wrap { max-width: 1200px; margin: 30px auto; padding: 0 20px; }
.view { display: none; } .view.active { display: block; }
.section-title { font-size: 0.8em; text-transform: uppercase; letter-spacing: 2px; color: var(--muted); margin: 30px 0 15px; display: flex; align-items: center; gap: 10px; }
.grid { display: grid; grid-template-columns: repeat(auto-fill, minmax(280px, 1fr)); gap: 20px; }

/* Cards */
.card { 
 background: var(--card); border-radius: 20px; padding: 25px; border: 1px solid var(--border); 
 cursor: pointer; box-shadow: 0 4px 6px -1px rgba(0,0,0,0.1);
}
.card:hover { transform: translateY(-4px); border-color: var(--accent); }
.card i { font-size: 1.5em; color: var(--accent); margin-bottom: 15px; }
.price-hero { font-size: 1.8em; font-weight: 700; color: var(--accent2); margin: 10px 0; }

/* Modal */
.modal-overlay { 
 position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.7); 
 backdrop-filter: blur(4px); display: none; align-items: center; justify-content: center; z-index: 2000;
}
.modal-window { 
 background: var(--card); width: 90%; max-width: 550px; border-radius: 24px; padding: 30px; 
 border: 1px solid var(--border); position: relative; max-height: 80vh; overflow-y: auto;
}
.close-btn { position: absolute; top: 20px; right: 20px; cursor: pointer; color: var(--muted); font-size: 1.2em; }

/* Calculator UI - New Layout */
.calc-grid { display: grid; grid-template-columns: 350px 1fr; gap: 30px; }
@media(max-width: 900px) { .calc-grid { grid-template-columns: 1fr; } }
.calc-panel { background: var(--glass); padding: 25px; border-radius: 20px; height: fit-content; }
.calc-panel select, .calc-panel input { 
 width: 100%; padding: 12px; margin-bottom: 15px; border-radius: 10px; border: 1px solid var(--border);
 background: var(--bg); color: var(--text);
}
.add-btn { background: var(--accent); color: #000; border: none; width: 100%; padding: 15px; border-radius: 12px; font-weight: 700; cursor: pointer; }
.calc-table { width: 100%; border-collapse: collapse; margin-top: 20px; background: var(--card); border-radius: 15px; overflow: hidden; border: 1px solid var(--border); }
.calc-table th { background: var(--glass); padding: 15px; text-align: left; font-size: 0.85em; color: var(--muted); }
.calc-table td { padding: 15px; border-bottom: 1px solid var(--border); }
.badge { padding: 4px 8px; border-radius: 6px; background: var(--glass); font-size: 11px; font-weight: 700; }

/* Dev Tab */
pre { background: #000; color: #7ee7c7; padding: 20px; border-radius: 15px; overflow-x: auto; font-size: 13px; border: 1px solid var(--border); }
</style>
</head>
<body data-theme="dark">

<nav>
    <div class="nav-brand"><i class="fa-solid fa-layer-group"></i> SCRAPBOARD</div>
    <div class="nav-tabs">
        <button class="tab-btn active" id="marketTab" onclick="switchTab('market')"><i class="fa-solid fa-chart-line"></i> Market Watch</button>
        <button class="tab-btn" id="calcTab" onclick="switchTab('calc')"><i class="fa-solid fa-calculator"></i> Scrap Calc</button>
        <button class="tab-btn" id="devTab" onclick="switchTab('dev')"><i class="fa-solid fa-code"></i> Dev Data</button>
    </div>
    <div class="nav-right">
        <select id="globalUnit" onchange="renderAll()" style="background:var(--glass); color:var(--text); border:none; padding:8px; border-radius:8px">
            <option value="lb">Lbs</option>
            <option value="kg">Kgs</option>
            <option value="oz">Oz</option>
            <option value="g">Grams</option>
        </select>
        <div class="theme-btn" onclick="toggleTheme()"><i class="fa-solid fa-moon" id="themeIcon"></i></div>
    </div>
</nav>

<div class="wrap">
    <div id="marketView" class="view active">
        <div class="section-title"><i class="fa-solid fa-gem"></i> Precious Metals (Spot)</div>
        <div class="grid" id="preciousGrid"></div>
        
        <div class="section-title"><i class="fa-solid fa-truck-pickup"></i> Scrap Yard Categories</div>
        <div class="grid" id="scrapGrid"></div>
    </div>

    <div id="calcView" class="view">
        <div class="calc-grid">
            <div class="calc-panel">
                <h3 style="margin-top:0; margin-bottom:20px; border-bottom:1px solid var(--border); padding-bottom:10px">Inventory Input</h3>
                <label class="badge" style="margin-bottom:10px; display:inline-block">1. Material Category</label>
                <select id="calcCatSelect" onchange="updateCalcItems()"></select>
                
                <label class="badge" style="margin-bottom:10px; display:inline-block">2. Grade / Type</label>
                <select id="calcItemSelect"></select>
                
                <label class="badge" style="margin-bottom:10px; display:inline-block">3. Weight</label>
                <input type="number" id="calcQty" value="1" step="any">
                
                <button class="add-btn" onclick="addToBasket()">ADD TO LIST</button>
            </div>

            <div>
                <div class="card" style="background:var(--accent); color:#000; border:none; cursor:default; margin-bottom: 20px;">
                    <h3 style="color:#000; opacity:0.7; margin:0">ESTIMATED PAYOUT</h3>
                    <div class="price-hero" id="grandTotal" style="color:#000; font-size:3.5em; margin: 10px 0">$0.00</div>
                    <button onclick="clearBasket()" style="width:100%; border:1px solid rgba(0,0,0,0.2); background:rgba(255,255,255,0.2); padding:10px; border-radius:8px; font-weight:700; cursor:pointer">CLEAR INVENTORY</button>
                </div>

                <table class="calc-table">
                    <thead><tr><th align="left">Material Description</th><th align="left">Weight</th><th align="right">Total Value</th><th style="width: 40px"></th></tr></thead>
                    <tbody id="basketBody"></tbody>
                </table>
            </div>
        </div>
    </div>

    <div id="devView" class="view">
        <div class="section-title"><i class="fa-solid fa-server"></i> Live API Response (GoldPrice.org)</div>
        <pre id="devOutput">Loading API Data...</pre>
    </div>
</div>

<div class="modal-overlay" id="modalOverlay" onclick="closeModal()">
    <div class="modal-window" onclick="event.stopPropagation()">
        <span class="close-btn" onclick="closeModal()"><i class="fa-solid fa-xmark"></i></span>
        <h2 id="modalTitle" style="color:var(--accent); margin-top:0">Breakdown</h2>
        <div id="modalContent"></div>
    </div>
</div>

<script>
/* -- DATA CONFIGURATION -- */
const SCRAP_DATA = {
    "Copper": {
        icon: "fa-solid fa-bolt-lightning",
        items: [
            {n: "Bare Bright Wire", p: 4.90}, {n: "#1 Tubing (Clean)", p: 4.70}, 
            {n: "#2 Tubing (Paint/Solder)", p: 4.60}, {n: "Tin Plated Bus", p: 4.60},
            {n: "Light Copper (Roofing)", p: 3.80}, {n: "Clean Al/Cu Coils", p: 2.30},
            {n: "Irony Al/Cu Coils", p: 2.10}
        ]
    },
    "Insulated Copper": {
        icon: "fa-solid fa-plug",
        items: [
            {n: "Heavy Ins. (85%+)", p: 3.20}, {n: "#1 Insulated (80%+)", p: 3.05},
            {n: "Romex (65%)", p: 2.60}, {n: "Communication (50%)", p: 1.60},
            {n: "Extension Cord (Clean)", p: 1.10}, {n: "Low Yield (35%)", p: 1.00},
            {n: "Christmas Lights", p: 0.20}, {n: "Insulated Heliax", p: 1.70},
            {n: "Aluminum MC", p: 1.50}, {n: "Steel BX", p: 0.50}
        ]
    },
    "Brass & Radiators": {
        icon: "fa-solid fa-faucet",
        items: [
            {n: "Yellow Brass (Clean)", p: 2.50}, {n: "Red Brass", p: 2.60},
            {n: "Clean Auto Radiators", p: 2.25}, {n: "Radiator Cores", p: 2.00}
        ]
    },
    "Aluminum": {
        icon: "fa-solid fa-car",
        items: [
            {n: "Alloy Wheels", p: 0.85}, {n: "Extruded Aluminum", p: 0.75},
            {n: "E.C. Wire (Clean)", p: 0.70}, {n: "Litho Plate", p: 0.60},
            {n: "Aluminum Siding", p: 0.60}, {n: "Chrome Wheels", p: 0.50},
            {n: "Mixed Aluminum Sheet", p: 0.50}, {n: "Clean Alum Radiators", p: 0.50},
            {n: "Aluminum Cans", p: 0.48}, {n: "Pet Food Cans", p: 0.15}
        ]
    },
    "E-Waste & Boards": {
        icon: "fa-solid fa-microchip",
        items: [
            {n: "Ceramic CPUs", p: 25.00}, {n: "RAM (Gold Plated)", p: 12.00},
            {n: "Telecom High-Grade Boards", p: 4.50}, {n: "Motherboards", p: 1.50}, 
            {n: "Hard Drives (w/ Board)", p: 0.50}, {n: "Power Supplies (Cut Wire)", p: 0.25}
        ]
    },
    "Stainless Steel": {
        icon: "fa-solid fa-kitchen-set",
        items: [
            {n: "316 Stainless", p: 0.40}, {n: "304 Prepared", p: 0.30}, {n: "304 Unprepared", p: 0.15}
        ]
    },
    "Motors & CBM": {
        icon: "fa-solid fa-gears",
        items: [
            {n: "Small Electric Motors", p: 0.30}, {n: "Large Electric Motors", p: 0.20},
            {n: "Sealed Units", p: 0.20}, {n: "Light Ballasts", p: 0.10}
        ]
    },
    "Steel & Iron": {
        icon: "fa-solid fa-bridge",
        items: [
            {n: "Cast Iron", p: 0.10}, {n: "Clean Cast Rotors", p: 0.10},
            {n: "Prepared #1 Steel", p: 0.10}, {n: "Vehicles (with Title)", p: 0.09},
            {n: "Chain Link Fence", p: 0.02}
        ]
    }
};

/* -- STATE & MATH CONSTANTS -- */
const state = {
    theme: 'dark',
    basket: JSON.parse(localStorage.getItem('scrapboard_basket') || '[]'),
    liveAPI: null
};

// Formatting & Conversions
const fmt = (v) => new Intl.NumberFormat('en-US', {style:'currency', currency:'USD'}).format(v);

// Convert a base LB price into the user's selected global unit.
function convertYardUnit(lbPrice) {
    const unit = document.getElementById('globalUnit').value;
    if(unit === 'kg') return lbPrice * 2.20462;
    if(unit === 'oz') return lbPrice / 16;
    if(unit === 'g') return lbPrice / 453.592;
    return lbPrice;
}

/* -- API FETCHING SCRIPT -- */
function fetchLiveRates() {
    const TARGET_URL = 'https://data-asg.goldprice.org/dbXRates/USD';
    const RATES_API_URL = 'https://api.allorigins.win/raw?url=' + encodeURIComponent(TARGET_URL);

    const OZ_TO_GRAM = 31.1035;
    const GRAM_TO_KG = 1000;
    const TOLA_TO_GRAM = 11.66;

    // Standard Purities for exact calculation
    const PURITIES = {
        "24K": 1.000, "22K": 0.9167, "20K": 0.8333,
        "18K": 0.7500, "16K": 0.6667, "14K": 0.5833,
        "12K": 0.5000, "10K": 0.4167
    };

    fetch(RATES_API_URL)
      .then(r => r.json())
      .then(apiResponse => {
        const collection = {};

        apiResponse.items.forEach(item => {
          const currency = item.curr;
          const goldOZ = item.xauPrice;
          const silverOZ = item.xagPrice;

          const goldG = goldOZ / OZ_TO_GRAM;
          const goldKG = goldG * GRAM_TO_KG;
          const goldTola = goldG * TOLA_TO_GRAM;

          const silverG = silverOZ / OZ_TO_GRAM;
          const silverKG = silverG * GRAM_TO_KG;
          const silverTola = silverG * TOLA_TO_GRAM;

          collection[currency] = {
            gold_rates: {
              Price_OZ: +goldOZ.toFixed(2),
              Price_G: +goldG.toFixed(2),
              Price_KG: +goldKG.toFixed(2),
              Price_Tola: +goldTola.toFixed(2),
              Price_24K: +(goldG * PURITIES["24K"]).toFixed(2),
              Price_22K: +(goldG * PURITIES["22K"]).toFixed(2),
              Price_20K: +(goldG * PURITIES["20K"]).toFixed(2),
              Price_18K: +(goldG * PURITIES["18K"]).toFixed(2),
              Price_16K: +(goldG * PURITIES["16K"]).toFixed(2),
              Price_14K: +(goldG * PURITIES["14K"]).toFixed(2),
              Price_12K: +(goldG * PURITIES["12K"]).toFixed(2),
              Price_10K: +(goldG * PURITIES["10K"]).toFixed(2),
            },
            silver_rates: {
              Price_OZ: +silverOZ.toFixed(2),
              Price_G: +silverG.toFixed(2),
              Price_KG: +silverKG.toFixed(2),
              Price_Tola: +silverTola.toFixed(2)
            }
          };
        });

        // Store globally and render Dev Tab
        state.liveAPI = collection['USD'];
        document.getElementById("devOutput").textContent = JSON.stringify(collection, null, 2);
        renderMarket(); // Re-render grid with fresh data
      })
      .catch(e => {
        document.getElementById("devOutput").textContent = "Error loading API: " + e.message; 
      });
}

/* -- UI & TAB NAVIGATION -- */
function switchTab(view) {
    document.querySelectorAll('.view').forEach(v => v.classList.remove('active'));
    document.querySelectorAll('.tab-btn').forEach(b => b.classList.remove('active'));
    document.getElementById(view + 'View').classList.add('active');
    document.getElementById(view + 'Tab').classList.add('active');
}

function toggleTheme() {
    state.theme = state.theme === 'dark' ? 'light' : 'dark';
    document.body.setAttribute('data-theme', state.theme);
    document.getElementById('themeIcon').className = state.theme === 'dark' ? 'fa-solid fa-moon' : 'fa-solid fa-sun';
}

/* -- RENDER MARKET VIEW -- */
function renderMarket() {
    const unit = document.getElementById('globalUnit').value;
    const gGrid = document.getElementById('preciousGrid');
    
    // Render Gold & Silver ONLY if API has loaded
    if (state.liveAPI) {
        gGrid.innerHTML = `
            <div class="card" onclick="openPreciousWindow('Gold')">
                <i class="fa-solid fa-coins"></i>
                <h3>GOLD</h3>
                <div class="price-hero">${fmt(state.liveAPI.gold_rates.Price_OZ)}</div>
                <div class="badge">Price / Troy Oz</div>
            </div>
            <div class="card" onclick="openPreciousWindow('Silver')">
                <i class="fa-solid fa-coins" style="color:#bdc3c7"></i>
                <h3>SILVER</h3>
                <div class="price-hero">${fmt(state.liveAPI.silver_rates.Price_OZ)}</div>
                <div class="badge">Price / Troy Oz</div>
            </div>
        `;
    } else {
        gGrid.innerHTML = `<div class="card"><h3 style="color:var(--muted)">Fetching Spot Prices...</h3></div>`;
    }

    // Render Scrap Groups
    document.getElementById('scrapGrid').innerHTML = Object.keys(SCRAP_DATA).map(cat => `
        <div class="card" onclick="openScrapWindow('${cat}')">
            <i class="${SCRAP_DATA[cat].icon}"></i>
            <h3>${cat}</h3>
            <div class="price-hero">${fmt(convertYardUnit(SCRAP_DATA[cat].items[0].p))}</div>
            <div class="badge">Starting / ${unit}</div>
        </div>
    `).join('');
}

/* -- MODAL LOGIC -- */
function openPreciousWindow(metal) {
    document.getElementById('modalTitle').innerText = metal + " Breakdown";
    const unit = document.getElementById('globalUnit').value;
    
    // Default to Grams for karat viewing if user has 'lb' selected (since Lb karats make no sense)
    const displayUnit = (unit === 'lb' || unit === 'kg') ? 'g' : unit; 
    let html = `<div class="badge" style="margin-bottom:15px">Displaying Per: ${displayUnit.toUpperCase()}</div>`;
    html += `<table class="calc-table"><thead><tr><th>Purity / Grade</th><th align="right">Price/${displayUnit}</th></tr></thead><tbody>`;
    
    if (metal === 'Gold') {
        const rates = state.liveAPI.gold_rates;
        // Determine the base to use for the table
        const baseTarget = displayUnit === 'oz' ? rates.Price_OZ : displayUnit === 'g' ? rates.Price_G : rates.Price_G;
        const perGramRatio = baseTarget / rates.Price_G; // factor to adjust the parsed gram karats
        
        const karats = ["24K", "22K", "20K", "18K", "16K", "14K", "12K", "10K"];
        karats.forEach(k => {
            const rawVal = rates["Price_" + k]; // This is per gram
            const adjVal = rawVal * perGramRatio;
            html += `<tr><td>${k} Gold</td><td align="right" class="price-hero" style="font-size:1.1em">${fmt(adjVal)}</td></tr>`;
        });
    } else {
        const r = state.liveAPI.silver_rates;
        const val = displayUnit === 'oz' ? r.Price_OZ : r.Price_G;
        html += `<tr><td>.999 Fine Silver</td><td align="right" class="price-hero" style="font-size:1.1em">${fmt(val)}</td></tr>`;
    }
    
    document.getElementById('modalContent').innerHTML = html + `</tbody></table>`;
    document.getElementById('modalOverlay').style.display = 'flex';
}

function openScrapWindow(cat) {
    document.getElementById('modalTitle').innerText = cat;
    const unit = document.getElementById('globalUnit').value;
    let html = `<table class="calc-table"><thead><tr><th>Material Grade</th><th align="right">Price/${unit}</th></tr></thead><tbody>`;
    
    SCRAP_DATA[cat].items.forEach(item => {
        html += `<tr><td>${item.n}</td><td align="right" class="price-hero" style="font-size:1.1em">${fmt(convertYardUnit(item.p))}</td></tr>`;
    });
    
    document.getElementById('modalContent').innerHTML = html + `</tbody></table>`;
    document.getElementById('modalOverlay').style.display = 'flex';
}

function closeModal() { document.getElementById('modalOverlay').style.display = 'none'; }

/* -- CALCULATOR LOGIC -- */
function initCalc() {
    const catSel = document.getElementById('calcCatSelect');
    catSel.innerHTML = Object.keys(SCRAP_DATA).map(c => `<option value="${c}">${c}</option>`).join('');
    updateCalcItems();
    renderBasket();
}

function updateCalcItems() {
    const cat = document.getElementById('calcCatSelect').value;
    document.getElementById('calcItemSelect').innerHTML = SCRAP_DATA[cat].items.map(i => `<option value="${i.p}">${i.n}</option>`).join('');
}

function addToBasket() {
    const itemSel = document.getElementById('calcItemSelect');
    state.basket.push({ 
        name: itemSel.options[itemSel.selectedIndex].text, 
        rate: Number(itemSel.value), // base LB rate
        qty: Number(document.getElementById('calcQty').value), 
        unit: document.getElementById('globalUnit').value 
    });
    localStorage.setItem('scrapboard_basket', JSON.stringify(state.basket));
    renderBasket();
}

function renderBasket() {
    const body = document.getElementById('basketBody');
    body.innerHTML = '';
    let total = 0;
    
    state.basket.forEach((it, i) => {
        // If the item unit matches the global unit, use the standard conversion
        // If it doesn't, we'd theoretically need cross-conversion, but for simplicity we convert the base rate to the saved unit.
        let displayRate = it.rate; 
        if(it.unit === 'kg') displayRate *= 2.20462;
        if(it.unit === 'oz') displayRate /= 16;
        if(it.unit === 'g') displayRate /= 453.592;

        const lineVal = displayRate * it.qty;
        total += lineVal;
        
        body.innerHTML += `
            <tr>
                <td><b>${it.name}</b><br><span style="font-size:11px;color:var(--muted)">Rate: ${fmt(displayRate)}/${it.unit}</span></td>
                <td>${it.qty} ${it.unit}</td>
                <td align="right"><b>${fmt(lineVal)}</b></td>
                <td align="right"><i class="fa-solid fa-trash-can" onclick="removeBasket(${i})" style="color:var(--danger); cursor:pointer"></i></td>
            </tr>`;
    });
    document.getElementById('grandTotal').innerText = fmt(total);
}

function removeBasket(i) { state.basket.splice(i,1); localStorage.setItem('scrapboard_basket', JSON.stringify(state.basket)); renderBasket(); }
function clearBasket() { state.basket = []; localStorage.removeItem('scrapboard_basket'); renderBasket(); }
function renderAll() { renderMarket(); renderBasket(); }

// Startup
fetchLiveRates();
initCalc();
</script>
</body>
</html>
