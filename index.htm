<!doctype html>
<html lang="en">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width,initial-scale=1" />
<title>Metal Tracker Pro | Live Market</title>
<link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;600;700&display=swap" rel="stylesheet">
<style>
:root{
  --bg:#041018; --card:#07101a; --muted:#9fb3c8;
  --accent:#ffd166; --accent-2:#7ee7c7; --glass: rgba(255,255,255,0.03);
  --success:#2ecc71; --danger:#ff6b6b;
}
*{box-sizing:border-box}
body{margin:0;font-family:Inter,system-ui;background:var(--bg);color:#e6f7ff;padding:20px}
.wrap{max-width:1100px;margin:auto}
header{display:flex;justify-content:space-between;align-items:center;margin-bottom:25px}
.controls{display:flex;gap:12px;margin-bottom:20px;flex-wrap:wrap}
select,input,button{background:var(--glass);border:1px solid rgba(255,255,255,0.1);color:inherit;padding:10px;border-radius:8px;outline:none}
button.primary{background:var(--accent);color:#041018;border:none;font-weight:700;cursor:pointer}
.grid{display:grid;grid-template-columns:1fr 340px;gap:20px}
@media(max-width:900px){.grid{grid-template-columns:1fr}}
.card{background:rgba(255,255,255,0.02);border-radius:14px;padding:20px;border:1px solid rgba(255,255,255,0.05);height:fit-content}
.rates-table{width:100%;border-collapse:collapse}
.rates-table td{padding:14px;border-top:1px dashed rgba(255,255,255,0.05)}
.k-rate{font-weight:700;color:var(--accent-2);font-size:1.3em}
.market-pill{font-size:12px;padding:4px 10px;border-radius:6px;font-weight:600}
.up{background:rgba(46,204,113,0.12);color:var(--success)}
.down{background:rgba(255,107,107,0.12);color:var(--danger)}
.conv-box{margin-top:20px;padding-top:20px;border-top:1px solid rgba(255,255,255,0.06)}
canvas{width:100%;height:100px;margin-top:15px;display:block}
.muted{color:var(--muted)}
</style>
</head>
<body>
<div class="wrap">
  <header>
    <div>
      <h2 style="margin:0">Metal Tracker <span style="color:var(--accent)">Pro</span></h2>
      <div id="market-summary" class="muted" style="font-size:13px">Waiting for market data...</div>
    </div>
    <div id="status" class="market-pill" style="background:var(--glass)">Booting...</div>
  </header>

  <div class="controls">
    <select id="currency"></select>
    <select id="unit">
      <option value="g">Gram</option>
      <option value="oz">Ounce</option>
      <option value="tola">Tola</option>
      <option value="kg">Kilo</option>
    </select>
    <button id="refresh" class="primary">Sync Market</button>
  </div>

  <div class="grid">
    <div class="card">
      <table class="rates-table"><tbody id="body"></tbody></table>
      <canvas id="spark" aria-hidden="true"></canvas>

      <div class="conv-box">
        <div class="muted" style="font-size:12px;margin-bottom:10px">Value Estimator</div>
        <div style="display:flex;gap:10px;align-items:center">
          <input type="number" id="calc-qty" value="10" style="width:100px">
          <span id="calc-label" class="muted">Units (as selected)</span>
          <div style="flex:1"></div>
          <b id="calc-result" class="k-rate">—</b>
        </div>
      </div>
    </div>

    <div class="card">
      <div class="muted" style="font-size:12px;margin-bottom:10px">Market Feed (JSON)</div>
      <div id="json" style="background:#02121a;padding:12px;border-radius:8px;font-family:monospace;font-size:11px;max-height:400px;overflow:auto"></div>
    </div>
  </div>
</div>

<script>
/* ---- Config ---- */
const TARGET = "https://data-asg.goldprice.org/dbXRates/USD";
const PROXIES = [
  u => `https://api.allorigins.win/get?url=${encodeURIComponent(u)}`,
  u => `https://corsproxy.io/?${encodeURIComponent(u)}`
];
const OZ = 31.1035, KG = 1000, TOLA = 11.66;
const PURITIES = {22:22/24, 21:21/24, 18:18/24};
/* ---------------- */

const el = {
  body: document.getElementById('body'),
  json: document.getElementById('json'),
  currency: document.getElementById('currency'),
  unit: document.getElementById('unit'),
  status: document.getElementById('status'),
  spark: document.getElementById('spark'),
  summary: document.getElementById('market-summary'),
  qty: document.getElementById('calc-qty'),
  res: document.getElementById('calc-result')
};

let cache = null;
let oldCache = null;

/* utility */
const toFixed = (v, n=2) => Number(Number(v).toFixed(n));
const pct = (newV, oldV) => {
  if (oldV === undefined || oldV === 0) return 0;
  return toFixed(((newV - oldV) / Math.abs(oldV)) * 100, 2);
};

/* ---- Proxy fetch with safe parsing ---- */
async function fetchMarket() {
  for (const p of PROXIES) {
    try {
      const url = p(TARGET);
      const res = await fetch(url, {cache: "no-store"});
      if (!res.ok) continue;
      const j = await res.json();
      // allorigins returns { contents: "..." }, corsproxy.io likely returns JSON directly
      if (j && typeof j.contents === 'string' && j.contents.trim()) {
        try {
          const parsed = JSON.parse(j.contents);
          if (parsed && parsed.items) return parsed;
        } catch (e) {
          // bad JSON -> continue to next proxy
          continue;
        }
      } else if (j && j.items) {
        return j;
      }
    } catch (e) {
      // ignore single-proxy failure; try next
      continue;
    }
  }
  return null;
}

/* ---- Convert API items to easier structure ---- */
function compute(api) {
  const out = {};
  api.items.forEach(i => {
    const cur = i.curr || "USD";
    const goldPerGram = (Number(i.xauPrice) || 0) / OZ;
    const silverPerGram = (Number(i.xagPrice) || 0) / OZ;
    out[cur] = {
      gold: {
        oz: toFixed(Number(i.xauPrice) || 0),
        g: toFixed(goldPerGram),
        kg: toFixed(goldPerGram * KG),
        tola: toFixed(goldPerGram * TOLA)
      },
      silver: {
        oz: toFixed(Number(i.xagPrice) || 0),
        g: toFixed(silverPerGram),
        kg: toFixed(silverPerGram * KG),
        tola: toFixed(silverPerGram * TOLA)
      }
    };
  });
  return out;
}

/* ---- Draw sparkline (per currency+unit) ---- */
function drawSpark(history, canvas) {
  const ctx = canvas.getContext('2d');
  const dpr = window.devicePixelRatio || 1;
  const cssW = canvas.offsetWidth;
  const cssH = canvas.offsetHeight;
  canvas.width = Math.floor(cssW * dpr);
  canvas.height = Math.floor(cssH * dpr);
  ctx.setTransform(dpr, 0, 0, dpr, 0, 0); // match CSS pixels

  ctx.clearRect(0, 0, cssW, cssH);
  if (!history || history.length < 2) return;
  const min = Math.min(...history);
  const max = Math.max(...history);
  const range = (max - min) || 1;
  ctx.beginPath();
  ctx.lineWidth = 2;
  ctx.strokeStyle = "#7ee7c7";
  history.forEach((v, i) => {
    const x = (i / (history.length - 1)) * cssW;
    const y = cssH - ((v - min) / range) * (cssH - 8) - 4; // padding
    if (i === 0) ctx.moveTo(x, y);
    else ctx.lineTo(x, y);
  });
  ctx.stroke();
}

/* ---- localStorage keyed history: currency + unit ---- */
function historyKey(currency, unit) {
  return `metalHistory_${currency}_${unit}`;
}
function pushHistory(currency, unit, value, maxLen=60) {
  const k = historyKey(currency, unit);
  const arr = JSON.parse(localStorage.getItem(k) || '[]');
  arr.push(value);
  if (arr.length > maxLen) arr.shift();
  localStorage.setItem(k, JSON.stringify(arr));
  return arr;
}
function loadHistory(currency, unit) {
  const k = historyKey(currency, unit);
  return JSON.parse(localStorage.getItem(k) || '[]');
}

/* ---- Render UI ---- */
function render() {
  if (!cache) return;
  const cur = el.currency.value || Object.keys(cache)[0];
  const unit = el.unit.value || 'g';
  const d = cache[cur];
  if (!d) return;

  // compute % change using previous cache (based on oz for stability)
  const old = oldCache && oldCache[cur] ? oldCache[cur] : null;
  const changeGoldPct = old ? pct(d.gold.oz, old.gold.oz) : 0;
  const changeSilverPct = old ? pct(d.silver.oz, old.silver.oz) : 0;

  const trendClass = v => (v > 0 ? 'up' : (v < 0 ? 'down' : ''));
  const trendIcon = v => (v > 0 ? '▲' : (v < 0 ? '▼' : '—'));
  const showPct = v => `${trendIcon(v)} ${Math.abs(v).toFixed(2)}%`;

  const gv = d.gold[unit];
  const sv = d.silver[unit];

  let html = '';
  html += `<tr><td><b>Gold Spot (24K)</b></td><td align="right"><span class="k-rate">${gv}</span> <span class="market-pill ${trendClass(changeGoldPct)}">${showPct(changeGoldPct)}</span></td></tr>`;
  Object.entries(PURITIES).forEach(([k, p]) => {
    const val = toFixed(gv * p);
    html += `<tr><td class="muted">${k}K Jewelry</td><td align="right">${val}</td></tr>`;
  });
  html += `<tr><td><b>Silver Spot</b></td><td align="right"><span class="k-rate">${sv}</span> <span class="market-pill ${trendClass(changeSilverPct)}">${showPct(changeSilverPct)}</span></td></tr>`;

  el.body.innerHTML = html;
  el.json.textContent = JSON.stringify(cache, null, 2);
  el.summary.textContent = `Market session: ${cur} • unit: ${unit.toUpperCase()} • last sync: ${new Date().toLocaleTimeString()}`;

  // converter
  const qty = Number(el.qty.value) || 0;
  const total = toFixed(qty * gv, 2);
  el.res.textContent = `${cur} ${total.toLocaleString()}`;

  // sparkline: store and draw history for this currency+unit
  const hist = pushHistory(cur, unit, gv, 60);
  drawSpark(hist, el.spark);
}

/* ---- Load + reconcile + UI wiring ---- */
async function load() {
  el.status.textContent = "Syncing...";
  try {
    const api = await fetchMarket();
    if (!api) {
      el.status.textContent = "Offline (proxy fail)";
      // still try to render from existing cache if any
      render();
      return;
    }
    oldCache = cache;
    cache = compute(api);

    // populate currency list if changed
    const list = Object.keys(cache);
    const currentOptions = [...el.currency.options].map(o => o.value);
    if (list.join(',') !== currentOptions.join(',')) {
      el.currency.innerHTML = list.map(c => `<option value="${c}">${c}</option>`).join('');
      // keep selected if possible
      if (currentOptions.includes(el.currency.value)) {
        el.currency.value = el.currency.value;
      } else {
        el.currency.value = (list.includes('USD') ? 'USD' : list[0]);
      }
    }

    render();
    el.status.textContent = `Market Open • ${new Date().toLocaleTimeString()}`;
  } catch (err) {
    console.error('load error', err);
    el.status.textContent = "Error";
    render();
  }
}

/* event wiring */
document.getElementById('refresh').addEventListener('click', load);
el.unit.addEventListener('change', () => {
  // redraw sparkline from the correct history for new unit
  const cur = el.currency.value || Object.keys(cache || {})[0];
  const hist = loadHistory(cur, el.unit.value);
  drawSpark(hist, el.spark);
  render();
});
el.currency.addEventListener('change', () => {
  const hist = loadHistory(el.currency.value, el.unit.value);
  drawSpark(hist, el.spark);
  render();
});
el.qty.addEventListener('input', render);

/* initial */
load();
/* friendly polling — longer on free proxies */
setInterval(load, 90000);
</script>
</body>
</html>