<!doctype html>
<html lang="en">
<head>
<meta charset="utf-8"/>
<meta name="viewport" content="width=device-width,initial-scale=1"/>
<title>Scrapn’ and Freshen Up II</title>
<link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;600;700&display=swap" rel="stylesheet">
<style>
:root{
 --bg:#020a0f; --card:#07101a; --muted:#9fb3c8;
 --accent:#ffd166; --accent2:#7ee7c7; --glass:rgba(255,255,255,0.04);
 --success:#2ecc71; --danger:#ff6b6b;
}
*{box-sizing:border-box}
body{margin:0;font-family:Inter,system-ui;background:var(--bg);color:#e6f7ff;padding:20px}
.wrap{max-width:1200px;margin:auto}
header{display:flex;justify-content:space-between;align-items:center;margin-bottom:20px}
.controls{display:flex;gap:10px;margin-bottom:20px;flex-wrap:wrap;background:var(--glass);padding:15px;border-radius:12px}
select,input,button{background:var(--glass);border:1px solid rgba(255,255,255,0.1);color:inherit;padding:10px;border-radius:8px;outline:none}
button.primary{background:var(--accent);color:#041018;border:none;font-weight:700;cursor:pointer}
.main-grid{display:grid;grid-template-columns:1fr 380px;gap:20px}
.cards-grid{display:grid;grid-template-columns:repeat(auto-fill, minmax(220px, 1fr));gap:15px}
@media(max-width:900px){.main-grid{grid-template-columns:1fr}}

.card{background:rgba(255,255,255,0.02);border-radius:14px;padding:15px;border:1px solid rgba(255,255,255,0.05);transition:transform 0.2s, background 0.2s}
.card:hover{background:rgba(255,255,255,0.05);transform:translateY(-2px)}
.clickable{cursor:pointer}
.k-rate{font-weight:700;color:var(--accent2);font-size:1.15em}
.up{color:var(--success)} .down{color:var(--danger)}
.small{font-size:12px;color:var(--muted)}
.badge{padding:3px 6px;border-radius:6px;background:rgba(255,255,255,0.02);font-size:11px}
.remove{cursor:pointer;color:var(--danger);font-weight:700}

.details-panel{margin-top:20px;padding:20px;background:var(--glass);border-radius:14px;border:1px solid var(--accent)}
.rates-table{width:100%;border-collapse:collapse;margin-top:10px}
.rates-table td{padding:10px 5px;border-top:1px solid rgba(255,255,255,0.05)}

.basket-card{position:sticky;top:20px}
.entries{width:100%;border-collapse:collapse;margin-top:10px}
.entries td, .entries th{padding:8px;border-top:1px solid rgba(255,255,255,0.04);font-size:12px;text-align:left}
pre{font-size:10px;color:var(--muted);background:#000;padding:10px;border-radius:8px;max-height:150px;overflow:auto}
</style>
</head>
<body>
<div class="wrap">
<header>
 <div>
  <h1 style="margin:0;font-size:1.5em">Scrapn’ and <span style="color:var(--accent)">Freshen Up II</span></h1>
  <div id="summary" class="small">Live Metals + Scrap Yard Feed</div>
 </div>
 <div id="status" class="badge">INITIALIZING</div>
</header>

<div class="controls">
 <select id="currency"></select>
 <select id="unitTop">
  <option value="lb">Pound (lb)</option>
  <option value="kg">Kilo (kg)</option>
  <option value="oz">Ounce (oz)</option>
  <option value="g">Gram (g)</option>
 </select>
 <button id="refreshBtn" class="primary" style="margin-left:auto">Sync Markets</button>
</div>

<div class="main-grid">
 <div>
  <h3 class="small" style="text-transform:uppercase;letter-spacing:1px">Live Precious Metals</h3>
  <div class="cards-grid" id="preciousGrid"></div>
  
  <h3 class="small" style="text-transform:uppercase;letter-spacing:1px;margin-top:30px">Scrap Yard Values</h3>
  <div class="cards-grid" id="scrapGrid"></div>

  <div id="detailsPanel" class="details-panel" style="display:none">
    <div style="display:flex;justify-content:space-between;align-items:center">
        <h2 id="detailsTitle" style="margin:0;color:var(--accent)">Category</h2>
        <button onclick="document.getElementById('detailsPanel').style.display='none'" class="small" style="background:none;border:none;cursor:pointer">✕ Close</button>
    </div>
    <div id="detailsContent"></div>
  </div>
 </div>

 <div class="basket-card">
  <div class="card">
    <div style="display:flex;justify-content:space-between;align-items:center">
        <span class="small" style="text-transform:uppercase">Inventory Basket</span>
        <div id="basketTotal" class="k-rate">$0.00</div>
    </div>
    <table class="entries">
        <thead><tr><th>Item</th><th>Qty</th><th>Value</th><th></th></tr></thead>
        <tbody id="entryBody"></tbody>
    </table>
    
    <hr style="border:none;border-top:1px solid rgba(255,255,255,0.06);margin:20px 0">
    
    <div class="small" style="margin-bottom:10px">Quick Add Item</div>
    <div style="display:grid;gap:10px">
        <select id="itemCatSelect"></select>
        <select id="itemSubSelect"></select>
        <div style="display:flex;gap:5px">
            <input type="number" id="itemQty" value="1" step="any" style="flex:1">
            <select id="itemUnit" style="width:70px">
                <option value="lb">lb</option>
                <option value="kg">kg</option>
                <option value="g">g</option>
                <option value="oz">oz</option>
            </select>
            <button id="addItemBtn" class="primary">Add</button>
        </div>
    </div>

    <div style="margin-top:30px">
        <div class="small">Live Data Debug</div>
        <pre id="jsonOut"></pre>
    </div>
  </div>
 </div>
</div>
</div>

<script>
const SCRAP = {
 "Copper": [
    {n:"Bare Bright Wire", p:4.90}, {n:"#1 Tubing", p:4.70}, {n:"#2 Tubing", p:4.60},
    {n:"Tin Plated Wire", p:4.60}, {n:"Enamel Coated", p:4.60}, {n:"Light Copper", p:3.80},
    {n:"Clean Alum/Copper Coils", p:2.30}, {n:"Irony Alum/Copper Coils", p:2.10}
 ],
 "Insulated Copper": [
    {n:"Heavy Ins. (85%+)", p:3.20}, {n:"#1 Insulated (80%+)", p:3.05}, {n:"Romex 65%", p:2.60},
    {n:"Communication 50%", p:1.60}, {n:"Clean Extension Cord", p:1.10}, {n:"Low Yield 35%", p:1.00},
    {n:"Christmas Lights", p:0.20}, {n:"Insulated Heliax", p:1.70}, {n:"Aluminum MC", p:1.50}, {n:"Steel BX", p:0.50}
 ],
 "Brass": [
    {n:"Yellow Brass", p:2.50}, {n:"Red Brass", p:2.60}, {n:"Clean Auto Radiators", p:2.25},
    {n:"Radiator Cores", p:2.00}
 ],
 "Stainless Steel": [
    {n:"304 Prepared", p:0.30}, {n:"304 Unprepared", p:0.15}, {n:"316 Stainless", p:0.40}
 ],
 "Aluminum": [
    {n:"Alloy Wheels", p:0.85}, {n:"Extruded", p:0.75}, {n:"E.C. Wire", p:0.70}, {n:"Litho Plate", p:0.60},
    {n:"MLC/New Clips", p:0.50}, {n:"Aluminum Siding", p:0.60}, {n:"Chrome Wheels", p:0.50},
    {n:"Mixed Alum/Old Sheet", p:0.50}, {n:"Clean Alum Radiators", p:0.50}, {n:"Dirty Alum Radiators", p:0.15},
    {n:"Cast Aluminum", p:0.50}, {n:"Aluminum Cans (<100lb)", p:0.45}, {n:"Aluminum Cans (>100lb)", p:0.48},
    {n:"Insulated E.C.", p:0.40}, {n:"Pet Food Cans", p:0.15}
 ],
 "Lead & Batteries": [
    {n:"Soft Lead", p:0.40}, {n:"Wheel Weights (Sorted)", p:0.15}, {n:"Wheel Weights (Unsorted)", p:0.10},
    {n:"Lead Acid Batteries", p:0.15}, {n:"Steel Cased Forklift", p:0.10}
 ],
 "CBM / Motors": [
    {n:"Small Electric Motors", p:0.30}, {n:"Large Electric Motors", p:0.20}, {n:"Light Ballasts", p:0.10},
    {n:"Sealed Units", p:0.20}
 ],
 "Steel": [
    {n:"Prepared #1", p:0.10}, {n:"Cast Iron", p:0.10}, {n:"Clean Cast Rotors", p:0.10},
    {n:"Shredder/Plate", p:0.09}, {n:"Vehicles", p:0.09}, {n:"Unprepared Bulky", p:0.05},
    {n:"Chain Link Fence", p:0.02}
 ]
};

const CFG = {
 TARGET: "https://data-asg.goldprice.org/dbXRates/USD",
 PROXIES: [u => `https://api.allorigins.win/get?url=${encodeURIComponent(u)}`, u => `https://corsproxy.io/?${encodeURIComponent(u)}`],
 LB: 1, KG: 0.453592, OZ: 16, G: 453.592, // Factors relative to LB
 PRECIOUS_OZ: 31.1035, // Troy oz to gram conversion for precious metals
 MOCK: { items: [{ curr:"USD", xauPrice:2340, xagPrice:28.50, xptPrice:980, xpdPrice:1020, pcXau:0.5, pcXag:-0.1, pcXpt:0.2, pcXpd:-0.4 }] }
};

const state = {
 cache: null,
 basket: JSON.parse(localStorage.getItem("scrapBasket")||"[]")
};

const el = {
 prec: preciousGrid, scrap: scrapGrid,
 curr: currency, unit: unitTop,
 status: status, summary: summary,
 refresh: refreshBtn, details: detailsPanel,
 detTitle: detailsTitle, detContent: detailsContent,
 catSel: itemCatSelect, subSel: itemSubSelect,
 qty: itemQty, itemUnit: itemUnit,
 addBtn: addItemBtn, basketBody: entryBody,
 basketTotal: basketTotal, json: jsonOut
};

const fmt = v => Number(v||0).toLocaleString(undefined,{minimumFractionDigits:2,maximumFractionDigits:2});
const trend = v => `<span class="${v>=0?'up':'down'}">${v>=0?'▲':'▼'} ${Math.abs(Number(v||0)).toFixed(2)}%</span>`;

// Weight conversion: converts price from per-lb to the target unit
const convertScrap = (pricePerLb, toUnit) => {
    const factors = { lb:1, kg: 1/0.453592, oz: 1/16, g: 1/453.592 };
    return pricePerLb * factors[toUnit];
};

async function sync(){
 el.status.textContent="SYNCING...";
 let data = CFG.MOCK;
 for(const p of CFG.PROXIES){
  try{
   const r=await fetch(p(CFG.TARGET));
   if(r.ok){
    const j=await r.json();
    data = j.contents ? JSON.parse(j.contents) : j;
    el.status.textContent="LIVE"; el.status.style.color="var(--success)";
    break;
   }
  }catch(e){}
 }
 if(el.status.textContent === "SYNCING") { el.status.textContent="MOCK"; el.status.style.color="var(--danger)"; }
 state.cache = data.items[0];
 el.json.textContent = JSON.stringify(data, null, 2);
 el.curr.innerHTML = `<option>${state.cache.curr}</option>`;
 render();
}

function render(){
 const u = el.unit.value;
 // Render Precious Metals
 const pm = [
    {n:"Gold", p:state.cache.xauPrice, c:state.cache.pcXau},
    {n:"Silver", p:state.cache.xagPrice, c:state.cache.pcXag},
    {n:"Platinum", p:state.cache.xptPrice, c:state.cache.pcXpt},
    {n:"Palladium", p:state.cache.xpdPrice, c:state.cache.pcXpd}
 ];
 el.prec.innerHTML = pm.map(m => `
    <div class="card clickable" onclick="showBreakdown('${m.n}', true)">
        <div class="small">${m.n}</div>
        <div class="k-rate">$${fmt(convertScrap(m.p * (16 / 1.09714), u))}</div>
        <div class="small">${trend(m.c)}</div>
    </div>
 `).join('');

 // Render Scrap Categories
 el.scrap.innerHTML = Object.keys(SCRAP).map(cat => {
    const topItem = SCRAP[cat][0];
    return `
    <div class="card clickable" onclick="showBreakdown('${cat}', false)">
        <div class="small">${cat}</div>
        <div class="k-rate">$${fmt(convertScrap(topItem.p, u))}</div>
        <div class="small">Per ${u} (starts at)</div>
    </div>`;
 }).join('');

 renderBasket();
}

window.showBreakdown = (cat, isPrecious) => {
    el.detTitle.textContent = cat;
    el.details.style.display = 'block';
    const u = el.unit.value;
    let html = `<table class="rates-table"><thead><tr class="small"><th>Sub-Type</th><th align="right">Price / ${u}</th></tr></thead><tbody>`;
    
    if(isPrecious) {
        const p = cat === 'Gold' ? state.cache.xauPrice : cat === 'Silver' ? state.cache.xagPrice : cat === 'Platinum' ? state.cache.xptPrice : state.cache.xpdPrice;
        const basePerLb = p * (16 / 1.09714);
        [1, 0.5, 0.25, 0.1].forEach(factor => {
            html += `<tr><td>${factor * 100}% Purity</td><td align="right" class="k-rate">$${fmt(convertScrap(basePerLb * factor, u))}</td></tr>`;
        });
    } else {
        SCRAP[cat].forEach(item => {
            html += `<tr><td>${item.n}</td><td align="right" class="k-rate">$${fmt(convertScrap(item.p, u))}</td></tr>`;
        });
    }
    el.detContent.innerHTML = html + `</tbody></table>`;
};

function initSelectors(){
    el.catSel.innerHTML = Object.keys(SCRAP).map(c => `<option value="${c}">${c}</option>`).join('');
    el.catSel.onchange = () => {
        const cat = el.catSel.value;
        el.subSel.innerHTML = SCRAP[cat].map(i => `<option value="${i.p}">${i.n}</option>`).join('');
    };
    el.catSel.onchange();
}

function renderBasket(){
    el.basketBody.innerHTML = '';
    let total = 0;
    state.basket.forEach((it, i) => {
        const val = convertScrap(it.pricePerLb, it.unit) * it.qty;
        total += val;
        el.basketBody.insertAdjacentHTML('beforeend', `
            <tr>
                <td>${it.name}<br><span class="small">$${fmt(it.pricePerLb)}/lb</span></td>
                <td>${it.qty}${it.unit}</td>
                <td class="k-rate">$${fmt(val)}</td>
                <td><span class="remove" onclick="removeItem(${i})">✕</span></td>
            </tr>
        `);
    });
    el.basketTotal.textContent = `$${fmt(total)}`;
}

window.removeItem = (i) => {
    state.basket.splice(i, 1);
    localStorage.setItem("scrapBasket", JSON.stringify(state.basket));
    renderBasket();
};

el.addBtn.onclick = () => {
    const name = el.subSel.options[el.subSel.selectedIndex].text;
    const pricePerLb = Number(el.subSel.value);
    state.basket.push({ name, pricePerLb, qty: Number(el.qty.value), unit: el.itemUnit.value });
    localStorage.setItem("scrapBasket", JSON.stringify(state.basket));
    renderBasket();
};

el.refresh.onclick = sync;
el.unit.onchange = render;

initSelectors();
sync();
setInterval(sync, 120000);
</script>
</body>
</html>
